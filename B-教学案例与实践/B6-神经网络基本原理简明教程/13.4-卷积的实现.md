Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https：//github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

# 卷积的实现

Python, for

img2col

numba

gpu


输入数据

N：样本图片数量（比如一次计算10张图片）
C：图片通道数量（比如红绿蓝三通道）
H：图片高度（比如224）
W：图片宽度（比如224）

定义卷积Weights

K：卷积核的数量（等于输出通道数）
C：输入图片通道数
FH：过滤器高度
FW：过滤器宽度

# 定义卷积核的权重矩阵类

```Python
class ConvWeightsBias(WeightsBias):
    def __init__(self, output_c, input_c, filter_h, filter_w, init_method, optimizer_name, eta):
        self.KernalCount = output_c
        self.FilterCount = input_c
        self.FilterHeight = filter_h
        self.FilterWidth = filter_w
        self.init_method = init_method
        self.optimizer_name = optimizer_name
        self.eta = eta
```
- KernalCount - 卷积核数量，一个卷积权重矩阵里包含一至多个卷积核，每个卷积核对应着一个输出通道，所以KernalCount = output_c。
- FilterCount - 过滤器数量，在一个卷积核内，每个通道都对应着一个过滤器，所以FilterCount = input_c
- FilterHeight, FilterWidgh - 过滤器的高度宽度，一般同为奇数
- init_method - 在使用ReLU激活函数时，一般用MSRA/HE初始化
- optimizer_name - 优化器的名称，如Adam等
- eta - 即学习率Learning Rate，在初始化优化器时使用

## 基本方法

- Initialize - 初始化
- CreateNew - 建立一个新的权重矩阵（与之相对的是使用以前相同的数据建立权重矩阵，以便于算法比较）
- Rotate180 - 将每个filter旋转180度，为了求前向梯度
- ClearGrads - 清空上次计算的梯度值
- MeanGrads - 梯度值除以样本数量
- Update - 更新梯度，此时会调用优化器的方法


# 定义卷积层类

```Python
class ConvLayer(CLayer):
    # define the number of input and output channel, also the filter size
    def __init__(self, 
                 input_shape,       # (InputChannelCount, H, W)
                 kernal_shape,      # (OutputChannelCount, FH, FW)
                 conv_param,        # (stride, padding)
                 activator, param):
        self.num_input_channel = input_shape[0]
        self.input_height = input_shape[1]
        self.input_width = input_shape[2]
        self.num_output_channel = kernal_shape[0]
        self.filter_height = kernal_shape[1]
        self.filter_width = kernal_shape[2]
        self.stride = conv_param[0]
        self.padding = conv_param[1]
        self.activator = activator
```

- num_input_channel, input_height, input_width - 输入数据的通道数，高，宽
- num_output_channel, filter_height, filter_width - 输出数据的通道数（卷积核数），卷积核过滤器的高和宽
- stride - 卷积步长
- padding - 是否填充
- activator - 激活函数

## 基本方法

- forward
- backward
- pre_update
- update
- save_parameters
- load_parameters